<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Zarduino" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>Arduino 4WD Car Controller - Responsive</title>
    <style>
        /* General styles - Mobile First */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px; /* Reduced padding for mobile */
            color: white;
            font-size: 14px; /* Base font size for mobile */
            transition: background-color 0.3s, color 0.3s; 
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px; /* Slightly reduced radius */
            padding: 15px; /* Reduced padding for mobile */
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25); /* Adjusted shadow */
            width: 100%;
            max-width: 400px; /* Max width for mobile-like view, expands with media queries */
            transition: background-color 0.3s, max-width 0.3s ease-in-out; 
        }

        h1 {
            text-align: center;
            margin-bottom: 15px; 
            font-size: 1.8em; /* Adjusted for mobile */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
         h2 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3em; /* Adjusted for mobile */
            color: #e0e0e0; /* Lighter subtitle */
        }

        .status-panel {
            display: grid;
            grid-template-columns: 1fr; /* Single column for mobile */
            gap: 10px; 
            margin-bottom: 20px; 
        }

        .status-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px; 
            padding: 12px; 
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .status-card h3 {
            margin-bottom: 6px; 
            font-size: 0.9em; 
            color: #fff; 
        }

        .status-value {
            font-size: 1.4em; 
            font-weight: bold;
            color: #4CAF50; 
        }

        .control-section {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        .bluetooth-controls, .car-controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px; 
            padding: 15px; 
            transition: background-color 0.3s; 
        }

        .bluetooth-controls h3, .car-controls h3 {
            margin-bottom: 12px; 
            text-align: center;
            color: #fff; 
            font-size: 1.1em; /* Adjusted for mobile */
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 18px; /* Adjusted padding for touch targets */
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em; /* Relative font size */
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            width: calc(100% - 10px); /* Make buttons take more width on mobile */
            display: block; /* Make buttons block to stack them */
        }
         .bluetooth-controls .btn, .car-controls .btn:not(.directional-pad .btn) { /* Target specific buttons */
            width: calc(100% - 10px); 
            margin-left: auto;
            margin-right: auto;
        }


        .btn:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            background: #555; 
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .directional-pad {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left center right"
                ". down .";
            gap: 8px; 
            max-width: 160px; /* Adjusted for mobile */
            margin: 15px auto; 
        }

        .directional-pad .btn { /* Override width for d-pad buttons */
            width: 48px; 
            height: 48px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em; /* Larger icons for touch */
            padding: 0; /* Remove padding to rely on width/height */
        }
        .btn-up { grid-area: up; }
        .btn-down { grid-area: down; }
        .btn-left { grid-area: left; } 
        .btn-right { grid-area: right; } 
        .btn-stop { 
            grid-area: center; 
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .gamepad-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px; 
            padding: 12px; 
            margin-top: 15px; 
            text-align: center;
            transition: background-color 0.3s;
        }
        .gamepad-info .btn { /* Gamepad connect button */
             width: calc(100% - 10px); 
             margin-left: auto;
             margin-right: auto;
        }


        .gamepad-status {
            font-size: 0.9em; 
            margin-bottom: 8px; 
        }

        .gamepad-instructions {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px; 
            padding: 10px; 
            margin-top: 10px; 
            transition: background-color 0.3s;
        }

        .gamepad-instructions h4 {
            margin-bottom: 6px; 
            color: #4CAF50; 
            font-size: 0.85em;
        }

        .gamepad-instructions ul {
            text-align: left;
            list-style: none;
            padding-left: 0;
            font-size: 0.8em;
        }

        .gamepad-instructions li {
            margin: 3px 0; 
            padding-left: 16px; 
            position: relative;
        }

        .gamepad-instructions li:before {
            content: "üéÆ";
            position: absolute;
            left: 0;
        }

        .connection-indicator {
            width: 10px; 
            height: 10px; 
            border-radius: 50%;
            background: #f44336; 
            display: inline-block;
            margin-left: 6px; 
            animation: pulse 2s infinite;
        }

        .connection-indicator.connected {
            background: #4CAF50; 
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dark-mode-toggle {
            position: fixed;
            top: 10px; 
            right: 10px; 
            z-index: 1000;
        }

        .dark-mode-toggle label {
            cursor: pointer;
            font-size: 1.8em; /* Larger toggle for touch */
        }

        .dark-mode-toggle input[type="checkbox"] {
            display: none; 
        }
        
        /* Dark Mode Styles (mostly unchanged, but will inherit mobile-first base) */
        body.dark-mode {
            background: #121212; 
            color: #e0e0e0; 
        }

        body.dark-mode .container {
            background: rgba(30, 30, 30, 0.5); 
            backdrop-filter: blur(8px); 
        }

        body.dark-mode .status-card {
            background: rgba(40, 40, 40, 0.7);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        body.dark-mode .status-card h3 { color: #ccc; }
        body.dark-mode .status-value { color: #50fa7b; }

        body.dark-mode .bluetooth-controls, 
        body.dark-mode .car-controls {
            background: rgba(35, 35, 35, 0.6);
        }
        body.dark-mode .bluetooth-controls h3, 
        body.dark-mode .car-controls h3 { color: #ccc; }

        body.dark-mode .gamepad-info { background: rgba(35, 35, 35, 0.6); }
        body.dark-mode .gamepad-instructions { background: rgba(50, 50, 50, 0.5); }
        body.dark-mode .gamepad-instructions h4 { color: #50fa7b; }
        
        footer {
            text-align: center;
            padding: 10px; 
            margin-top: auto; 
            width: 100%;
            color: white; 
            font-size: 0.8em; 
        }
        body.dark-mode footer { color: #aaa; }

        /* Tablet Styles */
        @media (min-width: 600px) {
            body {
                padding: 20px;
                font-size: 15px; /* Slightly larger base font */
            }
            .container {
                padding: 20px;
                max-width: 600px; /* Wider container for tablets */
                border-radius: 20px;
            }
            h1 { font-size: 2em; margin-bottom: 20px; }
            h2 { font-size: 1.4em; margin-bottom: 20px; }

            .status-panel {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Allow more cards per row */
                gap: 15px;
                margin-bottom: 25px;
            }
            .status-card { padding: 15px; border-radius: 15px;}
            .status-card h3 { font-size: 1em; }
            .status-value { font-size: 1.6em; }


            .control-section {
                grid-template-columns: 1fr 1fr; /* Two columns for controls */
                gap: 20px;
                margin-bottom: 25px;
            }
            .bluetooth-controls, .car-controls { padding: 20px; border-radius: 15px;}
            .bluetooth-controls h3, .car-controls h3 { font-size: 1.2em; margin-bottom: 15px;}

            .btn {
                padding: 12px 22px;
                font-size: 1em;
                 width: auto; /* Allow buttons to size to content */
                 display: inline-block; /* Allow side-by-side */
            }
            .bluetooth-controls .btn, .car-controls .btn:not(.directional-pad .btn), .gamepad-info .btn {
                 width: auto; /* Reset width for larger screens */
            }


            .directional-pad { max-width: 180px; }
            .directional-pad .btn { width: 55px; height: 55px; font-size: 1.6em; }
            
            .gamepad-info { padding: 15px; margin-top: 20px; border-radius: 15px;}
            .gamepad-status { font-size: 1em; margin-bottom: 10px; }
            .gamepad-instructions { padding: 12px; border-radius: 10px;}
            .gamepad-instructions h4 { font-size: 0.9em; }
            .gamepad-instructions ul { font-size: 0.85em; }

            .dark-mode-toggle { top: 15px; right: 15px; }
            .dark-mode-toggle label { font-size: 2em; }
            footer { font-size: 0.85em; padding: 15px;}
        }

        /* Desktop Styles */
        @media (min-width: 992px) {
            body {
                font-size: 16px; /* Standard desktop font size */
            }
            .container {
                padding: 30px;
                max-width: 800px; /* Max width for desktop */
            }
            h1 { font-size: 2.5em; margin-bottom: 30px;}
            h2 { font-size: 1.5em; margin-bottom: 25px;}

            .status-panel {
                 grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                 gap: 20px;
                 margin-bottom: 30px;
            }
             .status-card h3 { font-size: 1.1em; }
            .status-value { font-size: 1.8em; }


            .bluetooth-controls h3, .car-controls h3 { font-size: 1.3em; margin-bottom: 20px;}
            
            .btn {
                padding: 14px 24px;
                font-size: 1em;
            }
            .directional-pad { max-width: 200px; }
            .directional-pad .btn { width: 60px; height: 60px; font-size: 1.8em; }

            .gamepad-info { padding: 20px; }
            .gamepad-instructions { padding: 15px;}
            .gamepad-instructions h4 { font-size: 1em; }
            .gamepad-instructions ul { font-size: 0.9em; }

            .dark-mode-toggle { top: 20px; right: 20px; }
            footer { font-size: 0.9em; padding: 20px;}
        }

    </style>
</head>
<body>
    <div class="dark-mode-toggle">
        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
        <label for="darkModeToggle" id="darkModeEmoji">‚òÄÔ∏è</label>
    </div>

    <div class="container">
        <h1>üöó Arduino 4WD Car Controller</h1>
        <h2>Xbox Steering</h2>
        
        <div class="status-panel">
            <div class="status-card">
                <h3>Bluetooth Status</h3>
                <div class="status-value" id="bluetoothStatus">
                    Disconnected <span class="connection-indicator" id="btIndicator"></span>
                </div>
            </div>
            <div class="status-card">
                <h3>Steering Angle</h3>
                <div class="status-value" id="angleValue">--¬∞</div>
            </div>
            <div class="status-card">
                <h3>Mode</h3>
                <div class="status-value" id="modeValue">Manual</div> 
            </div>
        </div>

        <div class="control-section">
            <div class="bluetooth-controls">
                <h3>üîó Connection</h3>
                <button class="btn" id="connectBtn" onclick="connectBluetooth()">Connect to Car</button>
                <button class="btn danger" id="disconnectBtn" onclick="disconnectBluetooth()" disabled>Disconnect</button>
            </div>

            <div class="car-controls">
                <h3>üïπÔ∏è Manual Controls (App)</h3>
                <div class="directional-pad">
                    <button class="btn btn-up" id="forwardBtn">‚Üë</button>
                    <button class="btn btn-left" id="leftBtnApp">‚Üê</button> 
                    <button class="btn btn-stop" id="stopBtn">‚èπ</button>
                    <button class="btn btn-right" id="rightBtnApp">‚Üí</button> 
                    <button class="btn btn-down" id="backwardBtn">‚Üì</button>
                </div>
                 <div style="text-align: center; margin-top: 10px;">
                    <button class="btn" onclick="centerSteering()">Center Steering</button>
                </div>
            </div>
        </div>

        <div class="gamepad-info">
            <div class="gamepad-status" id="gamepadStatus">üéÆ Xbox Controller: Not Connected</div>
            <button class="btn" id="connectGamepadBtn" onclick="connectGamepad()">Connect Xbox Controller</button>
            
            <div class="gamepad-instructions">
                <h4>Xbox Controller Mapping:</h4>
                <ul>
                    <li><strong>App Buttons:</strong> Forward/Backward/Stop & App Steering</li>
                    <li><strong>Right Stick:</strong> Left/Right steering (Gamepad)</li>
                    <li><strong>A Button:</strong> Emergency Stop (Gamepad)</li>
                    <li><strong>X Button:</strong> Center Steering (Gamepad)</li>
                    <li><strong>Y Button:</strong> Connect/Disconnect Bluetooth (Gamepad)</li>
                </ul>
            </div>
        </div>
    </div>

    <footer>
        Made by Giscard
    </footer>

    <script>
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;
        let isConnected = false;
        let gamepadIndex = -1;
        let lastCommandSent = ''; 
        let isMoving = false; 

        let lastGamepadState = {
            rightStickX: 0, 
            buttons: {}
        };

        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeEmoji = document.getElementById('darkModeEmoji');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectGamepadBtn = document.getElementById('connectGamepadBtn');


        function setDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                darkModeEmoji.textContent = 'üåô'; 
                localStorage.setItem('darkMode', 'enabled');
            } else {
                document.body.classList.remove('dark-mode');
                darkModeEmoji.textContent = '‚òÄÔ∏è'; 
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        function toggleDarkMode() {
            setDarkMode(darkModeToggle.checked);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const savedMode = localStorage.getItem('darkMode');
            if (savedMode === 'enabled') {
                darkModeToggle.checked = true;
                setDarkMode(true);
            } else {
                darkModeToggle.checked = false;
                setDarkMode(false);
            }
            setupManualControls(); 
            updateModeDisplay(); 
            updateConnectionStatus(); 
        });

        function updateModeDisplay() {
            document.getElementById('modeValue').textContent = 'Manual';
        }

        async function connectBluetooth() {
            connectBtn.disabled = true;
            disconnectBtn.disabled = true; 

            try {
                console.log('Requesting Bluetooth Device...');
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [ 
                        { name: 'HC-06' }, 
                        { name: 'HC-05' },
                        { services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] } 
                    ],
                    optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
                });

                console.log('Connecting to GATT Server...');
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await bluetoothDevice.gatt.connect();
                
                console.log('Getting Service...');
                const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                
                console.log('Getting Characteristic...');
                bluetoothCharacteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
                
                await bluetoothCharacteristic.startNotifications();
                bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);
                
                isConnected = true;
                updateConnectionStatus();
                console.log('Connected successfully!');
                showCustomMessage('Bluetooth connected successfully!');
            } catch (error) {
                console.error('Bluetooth connection failed:', error);
                showCustomMessage(`Bluetooth connection failed: ${error.message}. Ensure car is on & discoverable.`);
                isConnected = false; 
                updateConnectionStatus(); 
            }
        }
        
        function onDisconnected() {
            console.log('Bluetooth device disconnected.');
            isConnected = false;
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
            updateConnectionStatus();
            showCustomMessage('Bluetooth device disconnected.');
        }

        async function disconnectBluetooth() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.removeEventListener('gattserverdisconnected', onDisconnected);
                bluetoothDevice.gatt.disconnect();
                console.log('Disconnected explicitly.');
            } else {
                 console.log('No active Bluetooth connection to disconnect or already disconnected.');
            }
            onDisconnected(); 
        }

        function updateConnectionStatus() {
            if (isConnected) {
                document.getElementById('bluetoothStatus').innerHTML = 'Connected <span class="connection-indicator connected"></span>';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                document.getElementById('bluetoothStatus').innerHTML = 'Disconnected <span class="connection-indicator"></span>';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        async function sendCommand(command) {
            if (!isConnected || !bluetoothCharacteristic) {
                console.warn('Not connected to car. Command not sent:', command);
                return;
            }
            if ((command === 'l' || command === 'r') && command === lastCommandSent) {
                return;
            }
            try {
                const encoder = new TextEncoder();
                await bluetoothCharacteristic.writeValue(encoder.encode(command));
                console.log('Sent command:', command);
                lastCommandSent = command; 
            } catch (error) {
                console.error('Error sending command:', error);
                showCustomMessage(`Error sending command: ${error.message}. Check connection.`);
                if (error.name === 'NetworkError' || error.message.includes('GATT operation failed')) {
                    console.log("Possible disconnection detected on send error.");
                    onDisconnected(); 
                }
            }
        }

        function handleBluetoothData(event) {
            const decoder = new TextDecoder();
            const data = decoder.decode(event.target.value);
            console.log('Received from Arduino:', data); 
            if (data.startsWith('ANGLE:')) {
                const angleValue = data.split(':')[1].trim();
                const angle = parseInt(angleValue);
                if (!isNaN(angle)) {
                    updateAngleDisplay(angle);
                } else {
                    console.warn("Received invalid angle data:", data);
                }
            }
        }

        function updateAngleDisplay(angle) {
            document.getElementById('angleValue').textContent = angle + '¬∞';
        }

        function setupManualControls() {
            const appMovementControls = {
                'forwardBtn': 'f',
                'backwardBtn': 'b',
                'stopBtn': 's' 
            };
            const appSteeringControls = {
                'leftBtnApp': 'l',
                'rightBtnApp': 'r'
            };

            Object.entries(appMovementControls).forEach(([btnId, command]) => {
                const btn = document.getElementById(btnId);
                if (!btn) { console.error("Button not found:", btnId); return; }
                const sendAndTrack = () => { 
                    if(isConnected) sendCommand(command); 
                    btn.style.transform = 'scale(0.95)'; 
                    isMoving = (command === 'f' || command === 'b'); 
                };
                const resetStyle = () => { btn.style.transform = 'scale(1)';};
                btn.addEventListener('mousedown', sendAndTrack);
                btn.addEventListener('mouseup', resetStyle);
                btn.addEventListener('mouseleave', resetStyle); 
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); sendAndTrack(); });
                btn.addEventListener('touchend', (e) => { e.preventDefault(); resetStyle(); });
            });

            Object.entries(appSteeringControls).forEach(([btnId, command]) => {
                const btn = document.getElementById(btnId);
                 if (!btn) { console.error("Button not found:", btnId); return; }
                const sendSteering = () => { if(isConnected) sendCommand(command); btn.style.transform = 'scale(0.95)'; };
                const resetSteeringStyle = () => { btn.style.transform = 'scale(1)';};
                btn.addEventListener('mousedown', sendSteering);
                btn.addEventListener('mouseup', resetSteeringStyle);
                btn.addEventListener('mouseleave', resetSteeringStyle);
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); sendSteering(); });
                btn.addEventListener('touchend', (e) => { e.preventDefault(); resetSteeringStyle(); });
            });
        }
        
        function centerSteering() {
            if(isConnected) sendCommand('c'); 
            console.log("Center steering command ('c') sent via app button.");
        }

        function connectGamepad() {
            if (gamepadIndex !== -1) { // If a gamepad is already connected, treat as disconnect
                window.dispatchEvent(new GamepadEvent("gamepaddisconnected", { gamepad: { index: gamepadIndex, id: "Manual Disconnect"} }));
                return;
            }

            if (navigator.getGamepads) {
                console.log('Gamepad API available. Setting up listeners...');
                // Check for already connected gamepads first
                const gamepads = navigator.getGamepads();
                let foundGamepad = false;
                for (let i = 0; i < gamepads.length; i++) {
                    if (gamepads[i] && gamepadIndex === -1) {
                        gamepadIndex = gamepads[i].index;
                        updateGamepadStatus(`üéÆ ${gamepads[i].id.substring(0,20)}...`);
                        startGamepadPolling();
                        connectGamepadBtn.textContent = "Disconnect Gamepad";
                        connectGamepadBtn.classList.add("danger");
                        foundGamepad = true;
                        console.log("Found already connected gamepad:", gamepads[i].id);
                        break; 
                    }
                }
                if (!foundGamepad && gamepadIndex === -1) { // If no gamepad found yet, add listeners
                     updateGamepadStatus('üéÆ Waiting for gamepad...');
                }
            } else {
                showCustomMessage('Gamepad API not supported in this browser.');
                if(connectGamepadBtn) connectGamepadBtn.disabled = true;
            }
        }
        
        let gamepadPollInterval = null;

        window.addEventListener("gamepadconnected", (e) => {
            console.log("Gamepad connected event:", e.gamepad.id, "Index:", e.gamepad.index);
            if (gamepadIndex === -1) { // Connect the first gamepad detected if none is active
                gamepadIndex = e.gamepad.index;
                updateGamepadStatus(`üéÆ ${e.gamepad.id.substring(0,20)}...`);
                startGamepadPolling(); 
                connectGamepadBtn.textContent = "Disconnect Gamepad";
                connectGamepadBtn.classList.add("danger");
            }
        });

        window.addEventListener("gamepaddisconnected", (e) => {
            console.log("Gamepad disconnected event:", e.gamepad.id, "Index:", e.gamepad.index);
            if (e.gamepad.index === gamepadIndex) { 
                gamepadIndex = -1;
                updateGamepadStatus('üéÆ Xbox Controller: Not Connected');
                stopGamepadPolling(); 
                connectGamepadBtn.textContent = "Connect Xbox Controller";
                connectGamepadBtn.classList.remove("danger");
            }
        });


        function startGamepadPolling() {
            if (gamepadPollInterval) clearInterval(gamepadPollInterval); 
            gamepadPollInterval = setInterval(pollGamepad, 50); 
            console.log("Gamepad polling started.");
        }

        function stopGamepadPolling() {
            if (gamepadPollInterval) {
                clearInterval(gamepadPollInterval);
                gamepadPollInterval = null;
                console.log("Gamepad polling stopped.");
            }
        }

        function updateGamepadStatus(status) {
            document.getElementById('gamepadStatus').textContent = status;
        }

        function pollGamepad() {
            if (gamepadIndex === -1 || !isConnected) { 
                return;
            }
            const gamepad = navigator.getGamepads()[gamepadIndex];
            if (!gamepad) {
                console.warn("Gamepad at index", gamepadIndex, "is null.");
                if (gamepadIndex !== -1) { 
                     window.dispatchEvent(new GamepadEvent("gamepaddisconnected", { gamepad: { index: gamepadIndex, id: "Unknown (null)"} }));
                }
                return;
            }

            const deadzone = 0.25;
            const rightStickX = gamepad.axes[2]; 
            if (Math.abs(rightStickX) > deadzone) {
                if (rightStickX > deadzone && lastGamepadState.rightStickX <= deadzone) sendCommand('r');
                else if (rightStickX < -deadzone && lastGamepadState.rightStickX >= -deadzone) sendCommand('l');
            }
            lastGamepadState.rightStickX = rightStickX;

            const buttons = gamepad.buttons;
            if (buttons[0] && buttons[0].pressed && (!lastGamepadState.buttons[0] || !lastGamepadState.buttons[0].pressed)) { sendCommand('s'); isMoving = false; console.log("Gamepad A: Stop"); }
            if (buttons[2] && buttons[2].pressed && (!lastGamepadState.buttons[2] || !lastGamepadState.buttons[2].pressed)) { sendCommand('c'); console.log("Gamepad X: Center"); }
            if (buttons[3] && buttons[3].pressed && (!lastGamepadState.buttons[3] || !lastGamepadState.buttons[3].pressed)) { console.log("Gamepad Y: BT Toggle (currently disabled).");}

            lastGamepadState.buttons = {};
            buttons.forEach((button, index) => { lastGamepadState.buttons[index] = { pressed: button.pressed, value: button.value }; });
        }
        
        function showCustomMessage(message) {
            let modal = document.getElementById('customMessageModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customMessageModal';
                Object.assign(modal.style, {
                    position: 'fixed', left: '0', top: '0', width: '100%', height: '100%',
                    backgroundColor: 'rgba(0,0,0,0.6)', display: 'flex',
                    justifyContent: 'center', alignItems: 'center', zIndex: '2000',
                    opacity: '0', transition: 'opacity 0.2s ease-in-out' 
                });

                const modalContent = document.createElement('div');
                 Object.assign(modalContent.style, {
                    padding: '20px', borderRadius: '10px', textAlign: 'center', // Adjusted padding
                    boxShadow: '0 8px 25px rgba(0,0,0,0.3)', width: '85%', maxWidth: '350px', // Max width for modal
                    transform: 'scale(0.95)', transition: 'transform 0.2s ease-in-out' 
                });
                
                const messageText = document.createElement('p');
                messageText.id = 'customMessageText';
                Object.assign(messageText.style, { marginBottom: '15px', fontSize: '1em'}); // Adjusted font size

                const closeButton = document.createElement('button');
                closeButton.textContent = 'OK';
                closeButton.className = 'btn'; 
                Object.assign(closeButton.style, {width: 'auto', padding: '10px 25px'}); // Ensure OK button is reasonably sized

                closeButton.onclick = function() { 
                    modal.style.opacity = '0';
                    modalContent.style.transform = 'scale(0.95)';
                    setTimeout(() => modal.style.display = 'none', 200); 
                };

                modalContent.appendChild(messageText);
                modalContent.appendChild(closeButton);
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                void modal.offsetWidth; 
            }
            
            document.getElementById('customMessageText').textContent = message;
            modal.style.display = 'flex';
            const modalContent = modal.querySelector('div'); 
            const closeButton = modal.querySelector('button');
            const isDark = document.body.classList.contains('dark-mode');
            
            modalContent.style.background = isDark ? '#3a3a3a' : '#f0f0f0'; 
            modalContent.style.color = isDark ? '#e8e8e8' : '#222';
            closeButton.style.background = isDark ? 'linear-gradient(45deg, #007bff, #0056b3)' : 'linear-gradient(45deg, #5cb85c, #4cae4c)'; 
            closeButton.style.color = 'white';

            setTimeout(() => {
                modal.style.opacity = '1';
                modalContent.style.transform = 'scale(1)';
            }, 10);
        }

        if (navigator.getGamepads) {
            console.log("Gamepad API available. Listeners are global.");
        } else {
            console.warn("Gamepad API not available.");
            if(connectGamepadBtn) connectGamepadBtn.disabled = true;
        }
    </script>
</body>
</html>
