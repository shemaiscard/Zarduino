<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Zarduino" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>Arduino 4WD Car Controller</title>
    <style>
        /* General styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
            transition: background-color 0.3s, color 0.3s; /* Smooth transition for dark mode */
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            transition: background-color 0.3s; /* Smooth transition for dark mode */
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s, border-color 0.3s; /* Smooth transition */
        }

        .status-card h3 {
            margin-bottom: 10px;
            color: #fff; /* Default light mode text color for card titles */
        }

        .status-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4CAF50; /* Default light mode value color */
        }

        .control-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .bluetooth-controls, .car-controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            transition: background-color 0.3s; /* Smooth transition */
        }

        .bluetooth-controls h3, .car-controls h3 {
            margin-bottom: 20px;
            text-align: center;
            color: #fff; /* Default light mode text color for section titles */
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .btn.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .btn.warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .directional-pad {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left center right"
                ". down .";
            gap: 10px;
            max-width: 200px;
            margin: 20px auto;
        }

        .directional-pad .btn {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .btn-up { grid-area: up; }
        .btn-down { grid-area: down; }
        .btn-left { grid-area: left; }
        .btn-right { grid-area: right; }
        .btn-stop { 
            grid-area: center; 
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .gamepad-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            transition: background-color 0.3s; /* Smooth transition */
        }

        .gamepad-status {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .gamepad-instructions {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            transition: background-color 0.3s; /* Smooth transition */
        }

        .gamepad-instructions h4 {
            margin-bottom: 10px;
            color: #4CAF50; /* Default light mode color */
        }

        .gamepad-instructions ul {
            text-align: left;
            list-style: none;
            padding-left: 0;
        }

        .gamepad-instructions li {
            margin: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .gamepad-instructions li:before {
            content: "üéÆ";
            position: absolute;
            left: 0;
        }

        .sensor-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            transition: background-color 0.3s; /* Smooth transition */
        }

        .distance-bar {
            background: #333; /* Default light mode bar background */
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s; /* Smooth transition */
        }

        .distance-fill {
            background: linear-gradient(90deg, #f44336, #ff9800, #4CAF50);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            min-width: 2px;
        }

        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336; /* Default disconnected color */
            display: inline-block;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        .connection-indicator.connected {
            background: #4CAF50; /* Default connected color */
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Dark Mode Toggle Styles */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .dark-mode-toggle label {
            cursor: pointer;
            font-size: 24px; /* Adjust emoji size */
        }

        .dark-mode-toggle input[type="checkbox"] {
            display: none; /* Hide the actual checkbox */
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a1a2e; /* Dark background */
            color: #e0e0e0; /* Lighter text for dark mode */
        }

        body.dark-mode .container {
            background: rgba(0, 0, 0, 0.3); /* Darker container */
            backdrop-filter: blur(5px); /* Slightly less blur for performance on dark */
        }

        body.dark-mode .status-card {
            background: rgba(0, 0, 0, 0.25);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        body.dark-mode .status-card h3 {
            color: #bbb; /* Adjusted text color for dark mode */
        }
        body.dark-mode .status-value {
            color: #38ef7d; /* Brighter green for dark mode */
        }

        body.dark-mode .bluetooth-controls, 
        body.dark-mode .car-controls {
            background: rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .bluetooth-controls h3, 
        body.dark-mode .car-controls h3 {
            color: #bbb; /* Adjusted text color for dark mode */
        }

        body.dark-mode .gamepad-info {
            background: rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .gamepad-instructions {
            background: rgba(255, 255, 255, 0.05);
        }
        body.dark-mode .gamepad-instructions h4 {
            color: #38ef7d; /* Brighter green for dark mode */
        }
        body.dark-mode .sensor-display {
             background: rgba(255, 255, 255, 0.08);
        }
        body.dark-mode .distance-bar {
            background: #555; /* Darker bar background */
        }
        
        /* Footer Styles */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: auto; /* Pushes footer to the bottom */
            width: 100%;
            color: white; /* Default light mode footer text */
            font-size: 0.9em;
        }
        body.dark-mode footer {
            color: #aaa; /* Dark mode footer text */
        }


        @media (max-width: 768px) {
            .control-section {
                grid-template-columns: 1fr;
            }
            
            .status-panel {
                grid-template-columns: 1fr;
            }
            .dark-mode-toggle {
                top: 10px;
                right: 10px;
            }
             .dark-mode-toggle label {
                font-size: 20px;
            }
        }

    </style>
</head>
<body>
    <div class="dark-mode-toggle">
        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
        <label for="darkModeToggle" id="darkModeEmoji">‚òÄÔ∏è</label>
    </div>

    <div class="container">
        <h1>üöó Arduino 4WD Car Controller</h1>
        
        <div class="status-panel">
            <div class="status-card">
                <h3>Bluetooth Status</h3>
                <div class="status-value" id="bluetoothStatus">
                    Disconnected <span class="connection-indicator" id="btIndicator"></span>
                </div>
            </div>
            <div class="status-card">
                <h3>Distance</h3>
                <div class="status-value" id="distanceValue">-- cm</div>
            </div>
            <div class="status-card">
                <h3>Steering Angle</h3>
                <div class="status-value" id="angleValue">--¬∞</div>
            </div>
            <div class="status-card">
                <h3>Mode</h3>
                <div class="status-value" id="modeValue">Manual</div>
            </div>
        </div>

        <div class="control-section">
            <div class="bluetooth-controls">
                <h3>üîó Connection</h3>
                <button class="btn" id="connectBtn" onclick="connectBluetooth()">Connect to Car</button>
                <button class="btn danger" id="disconnectBtn" onclick="disconnectBluetooth()" disabled>Disconnect</button>
                
                <div class="sensor-display">
                    <h4>Obstacle Detection</h4>
                    <div>Distance: <span id="sensorDistance">-- cm</span></div>
                    <div class="distance-bar">
                        <div class="distance-fill" id="distanceBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="car-controls">
                <h3>üéÆ Manual Controls</h3>
                <div class="directional-pad">
                    <button class="btn btn-up" id="forwardBtn">‚Üë</button>
                    <button class="btn btn-left" id="leftBtn">‚Üê</button>
                    <button class="btn btn-stop" id="stopBtn">‚èπ</button>
                    <button class="btn btn-right" id="rightBtn">‚Üí</button>
                    <button class="btn btn-down" id="backwardBtn">‚Üì</button>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn warning" id="autoModeBtn" onclick="toggleAutoMode()">Enable Auto Mode</button>
                    <button class="btn" onclick="centerSteering()">Center Steering</button>
                </div>
            </div>
        </div>

        <div class="gamepad-info">
            <div class="gamepad-status" id="gamepadStatus">üéÆ Xbox Controller: Not Connected</div>
            <button class="btn" onclick="connectGamepad()">Connect Xbox Controller</button>
            
            <div class="gamepad-instructions">
                <h4>Xbox Controller Mapping:</h4>
                <ul>
                    <li><strong>Left Stick:</strong> Forward/Backward movement</li>
                    <li><strong>Right Stick:</strong> Left/Right steering</li>
                    <li><strong>A Button:</strong> Emergency Stop</li>
                    <li><strong>B Button:</strong> Toggle Auto/Manual Mode</li>
                    <li><strong>X Button:</strong> Center Steering</li>
                    <li><strong>Y Button:</strong> Connect/Disconnect Bluetooth</li>
                </ul>
            </div>
        </div>
    </div>

    <footer>
        Made by Giscard
    </footer>

    <script>
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;
        let isConnected = false;
        let gamepadIndex = -1;
        let autoMode = false;
        let lastCommand = '';
        let isMoving = false;

        // Gamepad state tracking
        let lastGamepadState = {
            leftStickY: 0,
            rightStickX: 0,
            buttons: {}
        };

        // Dark Mode Functionality
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeEmoji = document.getElementById('darkModeEmoji');

        function setDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                darkModeEmoji.textContent = 'üåô'; // Moon for dark mode
                localStorage.setItem('darkMode', 'enabled');
            } else {
                document.body.classList.remove('dark-mode');
                darkModeEmoji.textContent = '‚òÄÔ∏è'; // Sun for light mode
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        function toggleDarkMode() {
            setDarkMode(darkModeToggle.checked);
        }

        // Check local storage for dark mode preference on load
        document.addEventListener('DOMContentLoaded', function() {
            const savedMode = localStorage.getItem('darkMode');
            if (savedMode === 'enabled') {
                darkModeToggle.checked = true;
                setDarkMode(true);
            } else {
                darkModeToggle.checked = false;
                setDarkMode(false);
            }

            setupManualControls();
            startGamepadPolling();
        });


        // Bluetooth Functions
        async function connectBluetooth() {
            try {
                console.log('Requesting Bluetooth Device...');
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { name: 'HC-06' },
                        { name: 'HC-05' },
                        { services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }
                    ],
                    optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
                });

                console.log('Connecting to GATT Server...');
                const server = await bluetoothDevice.gatt.connect();
                
                console.log('Getting Service...');
                const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                
                console.log('Getting Characteristic...');
                bluetoothCharacteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
                
                // Start notifications for incoming data
                await bluetoothCharacteristic.startNotifications();
                bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleBluetoothData);
                
                isConnected = true;
                updateConnectionStatus();
                
                console.log('Connected successfully!');
            } catch (error) {
                console.error('Bluetooth connection failed:', error);
                // Using a custom message box instead of alert
                showCustomMessage('Failed to connect to car. Make sure the car is powered on and nearby.');
            }
        }

        async function disconnectBluetooth() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            isConnected = false;
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
            updateConnectionStatus();
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('bluetoothStatus');
            // const indicator = document.getElementById('btIndicator'); // No longer directly manipulating this, CSS handles it with class
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (isConnected) {
                statusElement.innerHTML = 'Connected <span class="connection-indicator connected" id="btIndicator"></span>';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.innerHTML = 'Disconnected <span class="connection-indicator" id="btIndicator"></span>';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        async function sendCommand(command) {
            if (!isConnected || !bluetoothCharacteristic) {
                console.log('Not connected to car');
                return;
            }
            
            try {
                const encoder = new TextEncoder();
                await bluetoothCharacteristic.writeValue(encoder.encode(command));
                console.log('Sent command:', command);
                lastCommand = command;
            } catch (error)
                {
                console.error('Error sending command:', error);
            }
        }

        function handleBluetoothData(event) {
            const decoder = new TextDecoder();
            const data = decoder.decode(event.target.value);
            
            if (data.startsWith('DISTANCE:')) {
                const distance = parseInt(data.split(':')[1]);
                updateDistanceDisplay(distance);
            } else if (data.startsWith('ANGLE:')) {
                const angle = parseInt(data.split(':')[1]);
                updateAngleDisplay(angle);
            }
        }

        function updateDistanceDisplay(distance) {
            document.getElementById('distanceValue').textContent = distance + ' cm';
            document.getElementById('sensorDistance').textContent = distance + ' cm';
            
            // Update distance bar (0-100cm scale)
            const percentage = Math.min((distance / 100) * 100, 100);
            document.getElementById('distanceBar').style.width = percentage + '%';
        }

        function updateAngleDisplay(angle) {
            document.getElementById('angleValue').textContent = angle + '¬∞';
        }

        // Manual Controls
        function setupManualControls() {
            const controls = {
                'forwardBtn': 'f',
                'backwardBtn': 'b',
                'leftBtn': 'l',
                'rightBtn': 'r',
                'stopBtn': 's'
            };

            Object.entries(controls).forEach(([btnId, command]) => {
                const btn = document.getElementById(btnId);
                
                btn.addEventListener('mousedown', () => {
                    if (!autoMode) {
                        sendCommand(command);
                        btn.style.transform = 'scale(0.95)';
                        isMoving = command !== 's';
                    }
                });
                
                btn.addEventListener('mouseup', () => {
                    btn.style.transform = 'scale(1)';
                });
                
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'scale(1)';
                });
            });

            // Touch events for mobile
            Object.entries(controls).forEach(([btnId, command]) => {
                const btn = document.getElementById(btnId);
                
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // Prevent default touch behavior like scrolling or zooming
                    if (!autoMode) {
                        sendCommand(command);
                        btn.style.transform = 'scale(0.95)';
                        isMoving = command !== 's';
                    }
                });
                
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    btn.style.transform = 'scale(1)';
                });
            });
        }

        function toggleAutoMode() {
            autoMode = !autoMode;
            sendCommand('a'); // Send 'a' to toggle auto mode on Arduino
            
            const btn = document.getElementById('autoModeBtn');
            const modeDisplay = document.getElementById('modeValue');
            
            if (autoMode) {
                btn.textContent = 'Disable Auto Mode';
                btn.className = 'btn danger'; // Change class for styling
                modeDisplay.textContent = 'Auto';
            } else {
                btn.textContent = 'Enable Auto Mode';
                btn.className = 'btn warning'; // Change class for styling
                modeDisplay.textContent = 'Manual';
            }
        }

        function centerSteering() {
            sendCommand('c'); // Send 'c' to center steering on Arduino
        }

        // Xbox Gamepad Support
        function connectGamepad() {
            if (navigator.getGamepads) {
                console.log('Gamepad API supported');
                window.addEventListener("gamepadconnected", (e) => {
                    console.log("Gamepad connected:", e.gamepad);
                    gamepadIndex = e.gamepad.index;
                    updateGamepadStatus(`üéÆ ${e.gamepad.id}: Connected`);
                });

                window.addEventListener("gamepaddisconnected", (e) => {
                    console.log("Gamepad disconnected:", e.gamepad);
                    gamepadIndex = -1;
                    updateGamepadStatus('üéÆ Xbox Controller: Not Connected');
                });

                // Check for already connected gamepads
                const gamepads = navigator.getGamepads();
                for (let i = 0; i < gamepads.length; i++) {
                    if (gamepads[i]) {
                        gamepadIndex = gamepads[i].index;
                        updateGamepadStatus(`üéÆ ${gamepads[i].id}: Connected`);
                        break;
                    }
                }

            } else {
                 // Using a custom message box instead of alert
                showCustomMessage('Gamepad API not supported in this browser.');
            }
        }

        function updateGamepadStatus(status) {
            document.getElementById('gamepadStatus').textContent = status;
        }

        function startGamepadPolling() {
            setInterval(pollGamepad, 50); // Poll gamepad state at ~20 FPS
        }

        function pollGamepad() {
            if (gamepadIndex === -1) return; // No gamepad connected
            
            const gamepad = navigator.getGamepads()[gamepadIndex];
            if (!gamepad) return; // Gamepad not available

            // Left stick Y-axis for forward/backward (often inverted, so -gamepad.axes[1])
            const leftStickY = -gamepad.axes[1];
            const deadzone = 0.2; // Deadzone to prevent accidental movement
            
            if (Math.abs(leftStickY) > deadzone && !autoMode) {
                if (leftStickY > deadzone && lastGamepadState.leftStickY <= deadzone) { // Moved forward
                    sendCommand('f');
                    isMoving = true;
                } else if (leftStickY < -deadzone && lastGamepadState.leftStickY >= -deadzone) { // Moved backward
                    sendCommand('b');
                    isMoving = true;
                }
            } else if (Math.abs(leftStickY) <= deadzone && Math.abs(lastGamepadState.leftStickY) > deadzone && isMoving) { // Stick returned to center while moving
                sendCommand('s'); // Stop
                isMoving = false;
            }

            // Right stick X-axis for steering
            const rightStickX = gamepad.axes[2];
            if (Math.abs(rightStickX) > deadzone && !autoMode) {
                if (rightStickX > deadzone && lastGamepadState.rightStickX <= deadzone) { // Steer right
                    sendCommand('r');
                } else if (rightStickX < -deadzone && lastGamepadState.rightStickX >= -deadzone) { // Steer left
                    sendCommand('l');
                }
            } else if (Math.abs(rightStickX) <= deadzone && (Math.abs(lastGamepadState.rightStickX) > deadzone) && !autoMode) {
                 // Optionally send a command to straighten wheels or let Arduino handle it
                 // sendCommand('c'); // Example: center steering when stick returns to center
            }


            // Button handling (example: A, B, X, Y are typically buttons 0, 1, 2, 3)
            const buttons = gamepad.buttons;
            
            // A button (index 0) - Emergency Stop
            if (buttons[0] && buttons[0].pressed && !lastGamepadState.buttons[0]) {
                sendCommand('s');
                isMoving = false;
            }
            
            // B button (index 1) - Toggle Auto Mode
            if (buttons[1] && buttons[1].pressed && !lastGamepadState.buttons[1]) {
                toggleAutoMode();
            }
            
            // X button (index 2) - Center Steering
            if (buttons[2] && buttons[2].pressed && !lastGamepadState.buttons[2]) {
                centerSteering();
            }
            
            // Y button (index 3) - Connect/Disconnect Bluetooth
            if (buttons[3] && buttons[3].pressed && !lastGamepadState.buttons[3]) {
                if (isConnected) {
                    disconnectBluetooth();
                } else {
                    connectBluetooth();
                }
            }

            // Update last state for stick axes
            lastGamepadState.leftStickY = leftStickY;
            lastGamepadState.rightStickX = rightStickX;
            // Update last state for buttons
            lastGamepadState.buttons = {};
            buttons.forEach((button, index) => {
                lastGamepadState.buttons[index] = button.pressed;
            });
        }
        
        // Custom Message Modal (replaces alert)
        function showCustomMessage(message) {
            // Check if a modal already exists
            let modal = document.getElementById('customMessageModal');
            if (!modal) {
                // Create modal elements
                modal = document.createElement('div');
                modal.id = 'customMessageModal';
                modal.style.position = 'fixed';
                modal.style.left = '0';
                modal.style.top = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.justifyContent = 'center';
                modal.style.alignItems = 'center';
                modal.style.zIndex = '2000'; // Ensure it's on top

                const modalContent = document.createElement('div');
                modalContent.style.background = document.body.classList.contains('dark-mode') ? '#333' : '#fff';
                modalContent.style.color = document.body.classList.contains('dark-mode') ? '#eee' : '#333';
                modalContent.style.padding = '30px';
                modalContent.style.borderRadius = '10px';
                modalContent.style.textAlign = 'center';
                modalContent.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
                modalContent.style.maxWidth = '80%';


                const messageText = document.createElement('p');
                messageText.id = 'customMessageText';
                messageText.style.marginBottom = '20px';
                messageText.style.fontSize = '18px';

                const closeButton = document.createElement('button');
                closeButton.textContent = 'OK';
                closeButton.className = 'btn'; // Reuse existing button style
                closeButton.onclick = function() {
                    modal.style.display = 'none';
                };

                modalContent.appendChild(messageText);
                modalContent.appendChild(closeButton);
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
            }

            // Set message and display
            document.getElementById('customMessageText').textContent = message;
            modal.style.display = 'flex';
            // Update modal colors if dark mode is active
            const modalContent = modal.querySelector('div');
             modalContent.style.background = document.body.classList.contains('dark-mode') ? '#424242' : '#fff';
             modalContent.style.color = document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#333';
        }


        // Initialize gamepad detection (call it once, event listeners will handle connections)
        connectGamepad();
    </script>
</body>
</html>
